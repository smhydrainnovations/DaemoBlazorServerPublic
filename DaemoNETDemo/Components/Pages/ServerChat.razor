@page "/serverChat"
@rendermode InteractiveServer
@using System.Text.RegularExpressions
@using Daemo.SDK
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@inject DaemoClient AgentClient
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<PageTitle>Chatbot</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudPaper Elevation="4" Class="d-flex flex-column" Style="height: 80vh; min-height: 500px;">

        @* Header *@
        <MudToolBar Color="Color.Primary" Dense="true" Class="rounded-t">
            <MudIcon Icon="@Icons.Material.Filled.SmartToy" Class="mr-2" />
            <MudText Typo="Typo.h6">Server Chatbot Assistant</MudText>
            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Inherit" OnClick="@(() => messages.Clear())" />
        </MudToolBar>

        @* Chat Window *@
        <MudCardContent id="chat-window" Class="flex-grow-1 overflow-auto pa-4" Style="background-color: #f5f5f5;">
            @foreach (var message in messages)
            {
                <div class="d-flex @(message.IsBot ? "justify-start" : "justify-end") mb-4">
                    @if (message.IsBot)
                    {
                        <MudAvatar Color="Color.Info" Class="mr-2 mt-1" Size="Size.Small">
                            <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" />
                        </MudAvatar>
                    }

                    <MudPaper Class="pa-3"
                              Elevation="1"
                              Style="@(message.IsBot ? "background-color: white; max-width: 80%; border-radius: 4px 15px 15px 15px;"
                                                    : "background-color: var(--mud-palette-primary); color: white; max-width: 80%; border-radius: 15px 4px 15px 15px;")">
                        <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@message.Text</MudText>
                    </MudPaper>

                    @if (!message.IsBot)
                    {
                        <MudAvatar Color="Color.Primary" Class="ml-2 mt-1" Size="Size.Small">
                            <MudIcon Icon="@Icons.Material.Filled.Person" />
                        </MudAvatar>
                    }
                </div>
            }

            @if (isSending)
            {
                <div class="d-flex justify-start mb-4">
                    <MudAvatar Color="Color.Info" Class="mr-2 mt-1" Size="Size.Small">
                        <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" />
                    </MudAvatar>
                    <MudPaper Class="pa-3 bg-white" Elevation="1">
                        <MudProgressLinear Color="Color.Info" Indeterminate="true" Style="width: 100px;" />
                    </MudPaper>
                </div>
            }
        </MudCardContent>

        @* Footer / Input Area *@
        <MudDivider />
        <MudCardActions Class="pa-4 bg-white rounded-b">
            <MudTextField T="string"
                          @bind-Value="userInput"
                          Placeholder="Type your message..."
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Disabled="@isSending"
                          OnKeyUp="HandleKeyUp"
                          id="chat-input"
                          Adornment="Adornment.End"
                          AdornmentIcon="@Icons.Material.Filled.Send"
                          AdornmentColor="Color.Primary"
                          OnAdornmentClick="SendMessage"
                          Immediate="true"
                          FullWidth="true" />
        </MudCardActions>
    </MudPaper>
</MudContainer>

@code {
    private string? userInput;
    private List<ChatMessage> messages = new();
    private bool isSending = false;
    private string? varthreadId;

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await SendMessage();
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(userInput) || isSending) return;

        var prompt = userInput;
        userInput = string.Empty;
        messages.Add(new ChatMessage { Text = prompt, IsBot = false });
        isSending = true;

        // Auto-scroll after user message
        await ScrollToBottom();
        
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            var role = user.FindFirst(ClaimTypes.Role)?.Value;
            var applicationUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            var context = new Dictionary<string, string>
            {
                ["username"] = user.Identity?.Name ?? "Unknown",
                ["applicationUserId"] = applicationUserId ?? "Unknown"
            };

            var result = await AgentClient.ProcessQueryAsync(
                prompt,
                varthreadId,
                role: role,
                context: context,
                analysisMode: false
            );

            string botText;

            if (result == null)
            {
                botText = "_No response received from the server._";
            }
            else if (!result.Success)
            {
                botText = string.IsNullOrWhiteSpace(result.ErrorMessage)
                    ? "_The request failed, but no error message was provided._"
                    : $"⚠️ {result.ErrorMessage}";
            }
            else if (string.IsNullOrWhiteSpace(result.Response))
            {
                botText = "_The bot did not return any content._";
            }
            else
            {
                botText = result.Response.Trim();
            }

            messages.Add(new ChatMessage
            {
                IsBot = true,
                Text = botText
            });

            // Only update threadId if present
            if (!string.IsNullOrWhiteSpace(result?.ThreadId))
            {
                varthreadId = result.ThreadId;
            }
        }

        catch (Exception ex)
        {
            messages.Add(new ChatMessage { IsBot = true, Text = $"Exception: {ex.Message}" });
        }
        finally
        {
            isSending = false;
            await ScrollToBottom();
        }
    }

    private async Task ScrollToBottom()
    {
        // Give Blazor time to render the new message before scrolling
        await Task.Delay(50);
        await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;");
    }

    private class ChatMessage { public string? Text { get; set; } public bool IsBot { get; set; } }
}
