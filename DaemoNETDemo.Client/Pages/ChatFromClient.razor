@page "/chatfromclient"
@attribute [Authorize]
@rendermode InteractiveWebAssembly
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Json
@using System.Text.Json
@*@inject IAntiforgeryStateProvider AntiforgeryStateProvider*@
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@*<PageTitle>Client Chatbot</PageTitle>


    <div class="container mt-4">
        <div class="card shadow-sm mx-auto" style="max-width: 800px;">
            <div class="card-header bg-primary text-white text-center">
                <h5 class="mb-0">Chatbot</h5>
            </div>

            <div class="card-body overflow-auto" style="height: 500px; background-color: #f8f9fa;">
                @foreach (var message in messages)
                {
                    <div class="mb-3 @(message.IsBot ? "text-start" : "text-end")">
                        <div class="p-3 rounded shadow-sm d-inline-block @(message.IsBot ? "bg-white text-dark" : "bg-primary text-white")"
                             style="max-width: 85%; white-space: pre-wrap;">
                            <strong>@(message.IsBot ? "Bot" : "You"):</strong><br />
                            @message.Text
                        </div>
                    </div>
                }
            </div>

            <div class="card-footer bg-white">
                <div class="input-group">
                    <input type="text"
                           class="form-control"
                           @bind="userInput"
                           @onkeyup="HandleKeyUp"
                           disabled="@isSending" />

                    <button class="btn btn-primary"
                            @onclick="SendMessage"
                            disabled="@(isSending || string.IsNullOrWhiteSpace(userInput))">
                        Send
                    </button>
                </div>

                @if (isSending)
                {
                    <div class="text-primary mt-1 small">Processing...</div>
                }
            </div>
        </div>
    </div>*@

@*@code {
        private string? userInput;
        private bool isSending;
        private string? varthreadId = "";

        private List<ChatMessage> messages = new();

        private async Task HandleKeyUp(KeyboardEventArgs e)
        {
            if (e.Key == "Enter")
                await SendMessage();
        }

        private async Task SendMessage()
        {
            if (string.IsNullOrWhiteSpace(userInput) || isSending)
                return;

            var prompt = userInput;
            userInput = string.Empty;

            messages.Add(new ChatMessage { Text = prompt, IsBot = false });
            isSending = true;

            try
            {

                var response = await Http.PostAsJsonAsync("api/Chat/getchatresponse",
         new
         {
             Message = prompt,
             ThreadId = varthreadId
         });

                if (!response.IsSuccessStatusCode)
                {
                    messages.Add(new ChatMessage
                    {
                        IsBot = true,
                        Text = $"HTTP Error: {response.StatusCode}"
                    });
                    return;
                }

                var result = await response.Content.ReadFromJsonAsync<ChatApiResponse>();

                if (result?.Success == true)
                {
                    messages.Add(new ChatMessage
                    {
                        IsBot = true,
                        Text = result.Response
                    });

                    varthreadId = result.ThreadId;
                }
                else
                {
                    messages.Add(new ChatMessage
                    {
                        IsBot = true,
                        Text = $"Error: {result?.ErrorMessage ?? "Unknown error"}"
                    });
                }
            }
            catch (Exception ex)
            {
                messages.Add(new ChatMessage
                {
                    IsBot = true,
                    Text = $"Exception: {ex.Message}"
                });
            }
            finally
            {
                isSending = false;
            }
        }

        private class ChatMessage
        {
            public string? Text { get; set; }
            public bool IsBot { get; set; }
        }

        private class ChatApiResponse
        {
            public bool Success { get; set; }
            public string? Response { get; set; }
            public string? ThreadId { get; set; }
            public string? ErrorMessage { get; set; }
        }

        private class ChatRequest
        {
            public string Message { get; set; }
            public string ThreadId { get; set; }
        }
    }*@



<PageTitle>Client Chatbot</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudPaper Elevation="3" Class="d-flex flex-column" Style="height: 80vh; min-height: 500px; border-radius: 12px; overflow: hidden;">



        <MudToolBar Color="Color.Primary" Dense="true">
            <MudIcon Icon="@Icons.Material.Filled.Chat" Class="mr-2" />
            <MudText Typo="Typo.h6">Client Support Bot</MudText>
            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.DeleteSweep" Color="Color.Inherit" OnClick="@(() => messages.Clear())" />
        </MudToolBar>
        <MudCardContent id="chat-container" Class="flex-grow-1 overflow-auto pa-4" Style="background-color: var(--mud-palette-background-grey);">
            @foreach (var message in messages)
            {
                <div class="d-flex @(message.IsBot ? "justify-start" : "justify-end") mb-4">
                    @if (message.IsBot)
                    {
                        <MudAvatar Color="Color.Secondary" Size="Size.Small" Class="mr-2 mt-1">
                            <MudIcon Icon="@Icons.Material.Filled.SmartToy" />
                        </MudAvatar>
                    }

                    <MudPaper Class="pa-3"
                              Style="@(message.IsBot
                                       ? "background-color: white; color: black; border-radius: 4px 15px 15px 15px; max-width: 80%;"
                                       : "background-color: var(--mud-palette-primary); color: white; border-radius: 15px 4px 15px 15px; max-width: 80%;")">
                        <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@message.Text</MudText>
                    </MudPaper>

                    @if (!message.IsBot)
                    {
                        <MudAvatar Color="Color.Primary" Size="Size.Small" Class="ml-2 mt-1">
                            <MudIcon Icon="@Icons.Material.Filled.Person" />
                        </MudAvatar>
                    }
                </div>
            }

            @if (isSending)
            {
                <div class="d-flex justify-start mb-4">
                    <MudAvatar Color="Color.Secondary" Size="Size.Small" Class="mr-2 mt-1">
                        <MudIcon Icon="@Icons.Material.Filled.SmartToy" />
                    </MudAvatar>
                    <MudPaper Class="pa-3 bg-white" Style="border-radius: 4px 15px 15px 15px;">
                        <MudProgressLinear Color="Color.Secondary" Indeterminate="true" Style="width: 60px;" />
                    </MudPaper>
                </div>
            }
        </MudCardContent>


        <MudDivider />
        <MudCardActions Class="pa-4 bg-white">
            <MudTextField T="string"
                          @bind-Value="userInput"
                          Placeholder="Ask a question..."
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Disabled="@isSending"
                          OnKeyUp="HandleKeyUp"
                          Adornment="Adornment.End"
                          AdornmentIcon="@Icons.Material.Filled.Send"
                          AdornmentColor="Color.Primary"
                          OnAdornmentClick="SendMessage"
                          id="client-chat-input"
                          FullWidth="true"
                          Immediate="true" />
        </MudCardActions>
    </MudPaper>
</MudContainer>

@code {
    private string? userInput;
    private bool isSending;
    private string? varthreadId = "";
    private List<ChatMessage> messages = new();

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await SendMessage();
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(userInput) || isSending) return;

        var prompt = userInput;
        userInput = string.Empty;
        messages.Add(new ChatMessage { Text = prompt, IsBot = false });
        isSending = true;

        await ScrollToBottom();

        try
        {
            var response = await Http.PostAsJsonAsync("api/Chat/getchatresponse", new { Message = prompt, ThreadId = varthreadId });

            // Inside your chat client code
            // var request = new HttpRequestMessage(HttpMethod.Post, "api/Chat/getchatresponse");
            // request.Content = JsonContent.Create(new { Message = prompt, ThreadId = varthreadId });
            // This allows cookies to be sent with the request
            // request.SetBrowserRequestCredentials(BrowserRequestCredentials.Include);

            //   var response = await Http.SendAsync(request);

            if (!response.IsSuccessStatusCode)
            {
                messages.Add(new ChatMessage { IsBot = true, Text = $"HTTP Error: {response.StatusCode}" });
                return;
            }

            var result = await response.Content.ReadFromJsonAsync<ChatApiResponse>();

            if (result?.Success == true)
            {
                messages.Add(new ChatMessage { IsBot = true, Text = result.Response });
                varthreadId = result.ThreadId;
            }
            else
            {
                messages.Add(new ChatMessage { IsBot = true, Text = $"Error: {result?.ErrorMessage ?? "Unknown error"}" });
            }
        }
        catch (Exception ex)
        {
            messages.Add(new ChatMessage { IsBot = true, Text = $"Exception: {ex.Message}" });
        }
        finally
        {
            isSending = false;
            await ScrollToBottom();
        }
    }

    private async Task ScrollToBottom()
    {
        await Task.Delay(100); // Wait for render
        await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;");
    }

    private class ChatMessage { public string? Text { get; set; } public bool IsBot { get; set; } }
    private class ChatApiResponse { public bool Success { get; set; } public string? Response { get; set; } public string? ThreadId { get; set; } public string? ErrorMessage { get; set; } }
}
