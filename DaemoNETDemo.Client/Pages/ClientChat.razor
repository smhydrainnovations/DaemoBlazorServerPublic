@page "/clientChat"
@rendermode InteractiveWebAssembly
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using System.Text.Json
@using System.Text.RegularExpressions
@using Markdig
@using System.Net.Http.Json
@using System.Text.Json
@using MudBlazor
@using MudBlazor.Services
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<MudContainer>
    <MudPaper Elevation="2" Class="pa-4" MaxWidth="800px">
        <MudText Typo="Typo.h5" Class="text-center">Client Chatbot Assistant</MudText>

        <MudList T="ChatMessage">
            @foreach (var message in messages)
            {
                <MudListItem>
                    @if (message.IsBot)
                    {
                        <MudText Typo="Typo.body1" Class="font-weight-bold">Bot:</MudText>

                        @if (!string.IsNullOrEmpty(message.Text))
                        {
                            <!--  Safely render markdown or fallback -->
                            @if (IsMarkdownSafe(message.Text))
                            {
                                <div class="markdown-wrapper">
                                    <MudMarkdown Value="@message.Text" />
                                </div>
                            }
                            else
                            {

                                <pre style="background-color: #F9F9F9; color: #212121; padding: 10px; border-radius: 4px; white-space: pre-wrap;"> The prompt could not be processed. If it is valid prompt, the system administrator will get back to you.
                                 </pre>


                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">_No response from bot._</MudText>
                        }
                    }
                    else
                    {
                        <MudText Typo="Typo.body1"><b>You:</b> @message.Text</MudText>
                    }
                </MudListItem>
            }
        </MudList>

        <MudTextField @bind-Value="userInput" Label="Type your message..." FullWidth Disabled="@isSending" />
        <MudButton OnClick="SendMessage" Variant="Variant.Filled" Color="Color.Primary" Class="mt-2" Disabled="@isSending">
            @(isSending ? "Sending..." : "Send")
        </MudButton>

        <div class="my-4"></div>

        @if (isSending)
        {
            <MudStack Direction="Row" AlignItems="AlignItems.Center" Spacing="1" Class="mt-2">
                <MudProgressCircular Size="Size.Small" Color="Color.Primary" Indeterminate="true" />
                <MudText Typo="Typo.caption" Color="Color.Primary">Getting your answer...</MudText>
            </MudStack>
        }

    </MudPaper>
</MudContainer>

@code {
    private string? userInput;
    private List<ChatMessage> messages = new();
    private bool isSending = false;
    private string? varthreadId = "";

    private async Task SendMessage()
    {
        var prompt = userInput;
        userInput = string.Empty;

        if (!string.IsNullOrWhiteSpace(prompt))
        {
            messages.Add(new ChatMessage { Text = prompt, IsBot = false });
            isSending = true;

            try
            {

                var response = await Http.PostAsJsonAsync("api/Chat/getchatresponse", new { Message = prompt, ThreadId = varthreadId });
                        
                if (response.IsSuccessStatusCode)
                {
                    var chatResponse = await response.Content.ReadFromJsonAsync<ChatApiResponse>();

                    string botText;

                    if (chatResponse == null)
                    {
                        botText = "_No response received from the server._";
                    }
                    else if (!chatResponse.success)
                    {
                        botText = string.IsNullOrWhiteSpace(chatResponse.errorMessage)
                            ? "_The request failed, but no error message was provided._"
                            : $"⚠️ {chatResponse.errorMessage}";
                    }
                    else if (string.IsNullOrWhiteSpace(chatResponse.response))
                    {
                        botText = "_The bot did not return any content._";
                    }
                    else
                    {
                        botText = chatResponse.response.Trim();
                    }

                    messages.Add(new ChatMessage
                    {
                        IsBot = true,
                        Text = botText
                    });

                    // Only update threadId if it exists
                    if (!string.IsNullOrWhiteSpace(chatResponse?.threadId))
                    {
                        varthreadId = chatResponse.threadId;
                    }
                }

                else
                {
                    var errorText = await response.Content.ReadAsStringAsync();
                    messages.Add(new ChatMessage { IsBot = true, Text = $"Error from server: {errorText}" });
                }
            }
            catch (Exception ex)
            {
                messages.Add(new ChatMessage { IsBot = true, Text = $"Exception: {ex.Message}" });
            }
            finally
            {
                isSending = false;
            }
        }
    }

    // Safely render markdown with automatic fallback


    private static bool IsMarkdownSafe(string? text)
    {

        if (string.IsNullOrWhiteSpace(text))
            return true;

        try
        {
            text = text.Trim();

            //  If it’s pure JSON or XML - not markdown-safe
            if ((text.Contains("{") && text.Contains("}")) ||
                (text.Contains("[") && text.Contains("]")) ||
                (text.Contains("<") && text.Contains(">")))
            {
                return false;
            }

            //  Detect unbalanced code fences (```)
            int codeFenceCount = Regex.Matches(text, "```").Count;
            if (codeFenceCount % 2 != 0)
            {
                // Odd number of triple backticks → invalid markdown
                return false;
            }

            //  Check for very large or unstructured text (usually AI JSON or logs)
            if (text.Length > 2000 && !text.Contains("\n"))
            {
                // Long unbroken strings usually aren’t markdown
                return false;
            }

            // If the text contains obvious markdown patterns, assume safe
            if (Regex.IsMatch(text, @"(^|\s)[*_]{1,2}.+?[*_]{1,2}($|\s)") || // bold/italic
                Regex.IsMatch(text, @"(^|\n)#{1,6}\s") ||                    // headings
                text.Contains("- ") || text.Contains("* "))                  // lists
            {
                return true;
            }

            // Otherwise assume it’s plain text (safe)
            return true;
        }
        catch
        {
            // If anything unexpected happens, err on the side of caution
            return false;
        }
    }


    private class ChatMessage
    {
        public string? Text { get; set; }
        public bool IsBot { get; set; }

    }

    private class ChatApiResponse
    {
        public string? response { get; set; }
        public string? threadId { get; set; }
        public string? errorMessage { get; set; }

        public bool success { get; set; }
        public int executionTimeMs { get; set; }
        public List<ToolInteraction>? toolInteractions { get; set; }
    }

    private class ToolInteraction
    {
        public string? toolName { get; set; }
        public string? parametersJson { get; set; }
        public string? resultJson { get; set; }
        public bool success { get; set; } = false;
        public string? errorMessage { get; set; }
        public int executionTimeMs { get; set; }
    }

}
